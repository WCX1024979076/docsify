# 单片机复习

### 第3章 单片机的结构和原理

#### 51单片机的基本组成

![image-20220607190521599](https://img.tim-wcx.ltd/i/2022/06/07/629f310419d0c.png)

​	XTAL1、XTAL2：晶振	

​	PSEN: 片外程序存储器读选通信号输出端, 低电平有效。 

​	EA：片外程序存储器读选通信号输出端, 低电平有效。 

​	RST：复位信号

​	ALE：地址锁存信号

​	RXD：串行数据接收

​	TXD：串行数据发送

​	INT0：外部中断0请求输入线

​	INT1：外部中断1请求输入线

​	T0：定时器/计数器0计数输入线

​	T1：定时器/计数器1计数输入线

​	WE：外部RAM写信号

​	RD：外部RAM读信号

​	P0：地址/数据总线，**准双向IO**

​	P1：**准双向IO**

​	P2：地址总线，**准双向IO**

​	P3：控制总线，**准双向IO**


#### 51子系列单片机的存储器配置

1、8051存储器地址空间

  1. 片内、片外统一编址的程序存贮器ROM：64KB，地址：0000～0FFFFH；

     (低4KB，EA==0时外部ROM，否则内部ROM)

     MOVC指令访问

     PSEN片选读信号

  2. 片外数据存贮器RAM：64KB，地址：0000～0FFFFH；

     MOVX指令访问

     RD和WR信号

  3. 内部数据存贮器RAM：256B，地址：0~0FFH。

     MOV指令访问

2、ROM芯片

用途： 用于存放编好的程序和表格常数。

| 保留单元地址         | 入 口  地 址 | 用  途                                                   |
| ------------------------ | ---------------- | ------------------------------------------------------------ |
| 0000H～0002H | 0000H        | 复位后初始化引导程序                                     |
| 0003H～000AH | 0003H        | 外部中断0中断服务程序                            |
| 000BH～0012H | 000BH        | 定时/计数器0中断服务程序                 |
| 0013H～001AH | 0013H        | 外部中断1中断服务程序                            |
| 001BH～0022H | 001BH        | 定时/计数器1中断服务程序                 |
| 0023H～002AH | 0023H        | 串行口中断服务程序                                       |
| 002BH～0032H | 002BH        | 定时/计数器2中断服务程序(52子系列才有) |

3、RAM芯片

用途：用于存放运算的中间结果、数据暂存和缓冲、标志位等。

分类：片内RAM： 256字节；地址从0000～00FFH；片外RAM： 64K字节；地址从0000～FFFFH。

片内RAM：高128单元80H~0FFH SFR

​					低128单元00H~7FH 真正的RAM

![内部RAM](https://img.tim-wcx.ltd/i/2022/06/08/62a01f2d26aa5.png)

3.1 低128单元：

1）存储器区：四组寄存器，每组8个寄存单元（8位），各组都以R0、R1、R2、R3、R4、R5、R6、R7作寄存单元编号。寄存器常用于存放操作数及中间结果等，由于它们的功能及使用不作预先规定因此称之为通用寄存器，有时也叫工作寄存器、四组通用寄存器占据内部RAM的00H～1FH单元地址。

在任一时刻，CPU只能使用其中的一组寄存器，并且把正在使用的那组寄存器称之为当前寄存器组。到底是那一组由程序状态字寄存器PSW中RS0、RS1位的状态组合来决定。

R0～R7寄存器与内部RAM的地址对应

| 通用寄存器  名称 | 地  址        |                   |                   |         |
| ------------------------ | ----------------- | ----------------- | ----------------- | ------- |
| 第0组        | 第1组 | 第2组 | 第3组 |         |
| R0                   | 00H           | 08H           | 10H           | 18H |
| R1                   | 01H           | 09H           | 11H           | 19H |
| R2                   | 02H           | 0AH           | 12H           | 1AH |
| R3                   | 03H           | 0BH           | 13H           | 1BH |
| R4                   | 04H           | 0CH           | 14H           | 1CH |
| R5                   | 05H           | 0DH           | 15H           | 1DH |
| R6                   | 06H           | 0EH           | 16H           | 1EH |
| R7                   | 07H           | 0FH           | 17H           | 1FH |

2） 位寻址区：

地址：20H～2FH单元，共128位。

位地址：00H～7FH。

性质：既可作为一般RAM单元使用进行字节操作，也可以对单元中的每一位进行位操作，因此把该区称之为位寻址区。

3） 用户RAM区：

单元地址为30H～7FH，主要的数据缓冲区。

把堆栈开辟在此区。

3.2 高128单元：

特殊功能寄存器区、专用寄存器区 简称SFR。

单元地址：80H～FFH。

（1）累加器A或ACC（Accumulator）==0E0H==

8位寄存器，是最常用的专用寄存器

大部分单操作数指令的操作数就取自ACC，许多双操作数指令中的一个操作数也取自累加器。

（2） B寄存器 ==0F0H==

8位寄存器，主要用于乘除运算。如 MUL   AB

B寄存器也可作为一般数据寄存器使用。如MOV  B, #20H

（3） 数据指针（DPTR）16位寄存器

MCS-51中唯一的一个16位寄存器。

DPH：DPTR高位字节 ==83H==

DPL：DPTR低位字节 ==82H==

作用：通常在访问外部RAM时作地址指针使用, 由于外部数据存储器的寻址范围64KB。

DPTR既可按16位寄存器使用，也可以按两个8位寄存器分开使用。如： 

MOV   DPTR， #1234H  <==> MOV	DPH， #12H；MOV   DPL，  #34H

（4）程序计数器PC（Program Counter）

PC：16位的计数器。

其内容为将要执行的指令地址，寻址范围达64KB。  

有自动加 1功能，从而实现程序的顺序执行、 但PC没有地址，是不可寻址的、因此无法对它进行读写。但可以通过转移、调用、返回等指令改变其内容，以实现程序的转移。

（5）I/O端口P0～P3==（80H，90H，A0H，B0H）==

P0～P3为四个8位特殊功能寄存器，分别是四个并行I/O端口的锁存器。它们都有字节地址，每一个口锁存器还有位地址，所以当每一条I/O线独立地用作输入或输出时，数据可以锁存；作输入时，数据可以缓冲。

当I/O端口某一位用于输入信号时，对应的锁存器必须先置“1”。RST初始化为FFH

（6）程序状态字PSW（Program Status Word） ==0D0H==

8位寄存器，用于寄存程序运行的状态信息。

其中：有些位状态是根据程序执行结果，由硬件自动设置的而有些位状态则使用软件方法设定．

| D7                            | D6                                           | D5                                               | D4             |       D3       | D2                                                           | D1                              | D0                                                          |
| ----------------------------- | -------------------------------------------- | ------------------------------------------------ | -------------- | :------------: | ------------------------------------------------------------ | ------------------------------- | ----------------------------------------------------------- |
| CY                            | AC                                           | F0                                               | RS1            |      RS0       | OV                                                           | ...                             | P                                                           |
| 进位标志位                    | 辅助进位标志位                               | 用户标志位                                       | 寄存器组选择位 | 寄存器组选择位 | 溢出标志位                                                   | 外部中断0请求中断标志位         | 奇偶标志位                                                  |
| 有进位/借位，CY=1，否则，CY=0 | 低4位向高4位的进位或借位。有AC=1，否则AC=0。 | 需要时用软件方法置位或复位，用以控制程序的转向。 |                |                | 8位带符号数字加减运算结果是否超出运算范围。8位有符号数字表示的范围：－128～＋127。OV＝0，运算正确，即无溢出产生。在乘法运算中，OV＝1，表示乘积超过255；在除法运算中，OV＝1，表示除数为0，除法不能进行。 | IE1=1，INT0有中断产生(硬件控制) | 表明累加器A中1个个数的奇偶性，奇1偶0（串行输入输出的第9位） |

（7）PCON 电源控制  ==87H==

| D7   | D6      | D5             | D4    | D3  | D2  | D1 | D0  |
| -------- | ----------- | ------------------ | --------- | ------- | ------- | ------ | :-----: |
| SMOD | (SMOD0) | (LVDF) | (P0F) | GF1 | GF0 | PD | IDL |
| 与串口通信有关               | 单片机特有 | 单片机特有 | 单片机特有 | 通用工作标志位，用户可以自由使用。 | 通用工作标志位，用户可以自由使用。 | 掉电模式设定位。 |空闲模式设定位。|
| SMOD=0; 串口方式1，2，3时，波特率正常。SMOD=1; 串口方式1，2，3时，波特率加倍。 | \ | \ | \ | \ | \ | PD=0 单片机处于正常工作状态。PD=1 单片机进入掉电(Power Down)模式，可由外部中断或硬件复位模式唤醒，进入掉电模式后，外部晶振停振，CPU、定时器、串行口全部停止工作，只有外部中断工作。 |IDL=0 单片机处于正常工作状态。IDL=1 单片机进入空闲(Idle)模式，除CPU不工作外，其余仍继续工作，在空闲模式下可由任一个中断或硬件复位唤醒。|

（7）TCON 时钟控制  ==8FH~88H==

| D7                                | D6                  | D5                                | D4                  | D3                                | D2                            | D1                              | D0                            |
| ---- | --------------------------------- | :-----------------: | --------------------------------- | ------------------- | --------------------------------- | ----------------------------- | ----------------------------- |
| TF1                               | TR1                 | TF0                               | TR0                 | IE1                               | IT1                           | IE0                             | IT0                         |
| T1溢出标志位                      | 定时计数器1控制位   | T0溢出标志位                      | 定时计数器0控制位   | 外部中断INT1请求中断标志位        | 外部中断INT1触发方式控制位    | 外部中断0请求中断标志位         | 外部中断INT0触发方式控制位 |
| TF1=1表示T1有中断产生（硬件控制）当转向中断服务时，再由硬件自动清0。 | TR1=1表示T1开始运行 | TF0=1表示T0有中断产生（硬件控制）当转向中断服务时，再由硬件自动清0。 | TR0=1表示T0开始运行 | IE1=1，INT1有中断产生（硬件控制）在中断响应完成后转向中断服务时，再由硬件自动清零。 | IT1=1时，INT1为跳变沿触发方式，后沿负跳有效；IT1=0时，INT1为电平方式，低电平有效。 | IE1=1，INT0有中断产生(硬件控制)在中断响应完成后转向中断服务时，再由硬件自动清零。 | IT0=1时，INT0为跳变沿触发方式，后沿负跳有效；IT0=0时，INT0为电平方式，低电平有效。 |

（8）定时器TMOD  ==90H~89H==

TMOD寄存器不能位寻址，只能用字节传送指令设置其内容。 复位后，TMOD＝0。

当GATE＝0时，若TR0=1，接通计数控制K，启动T0在原计数值上加1计数，直至溢出。若TR0＝0，则关断控制开关，停止计数。将此方式称为软件启动。

当GATE＝1，且TR0＝1时，或门、与门全部打开，外信号电平通过INT0引脚直接开启或关断定时器计数。输入1电平时，允许计数，否则停止计数。称为硬件启动。

| 定时器1 |                                        |                                 |                                 | 定时器0 |                                        |                                 |                                 |
| ------- | -------------------------------------- | :-----------------------------: | ------------------------------- | ------- | -------------------------------------- | ------------------------------- | ------------------------------- |
| 7       | 6                                      |               *5*               | 4                               | 3       | 2                                      | 1                               | 0                               |
| GATE    | C/T                                    |               M1                | M0                              | GATE    | C/T                                    | M1                              | M0                              |
| 门控制  | C/T=0，定时器模式。C/T=1，计数器模式。 | 用来选择定时计/计数器的工作方式 | 用来选择定时计/计数器的工作方式 | 门控制  | C/T=0，定时器模式。C/T=1，计数器模式。 | 用来选择定时计/计数器的工作方式 | 用来选择定时计/计数器的工作方式 |

| M1   | M0   | 工作方式 | 功能描述                                      |
| ---- | ---- | -------- | --------------------------------------------- |
| 0    | 0    | 方式0    | 13位计数器                                    |
| 0    | 1    | 方式1    | 16位计数器                                    |
| 1    | 0    | 方式2    | 自动再装入8位计数器                           |
| 1    | 1    | 方式3    | 定时器0：分为两个8位计数器，定时器1：停止计数 |

（9）总中断允许IE  ==0AFH~0A8H==

| D7                | D6   | D5   | D4                   |           D3           | D2                       | D1                     | D0                       |
| ----------------- | ---- | ---- | -------------------- | :--------------------: | ------------------------ | ---------------------- | ------------------------ |
| EA                | -    | -    | ES                   |          ET1           | EX1                      | ET0                    | EX0                      |
| 总允许位          |      |      | 串行口中断允许位     | 定时器T1溢出中断允许位 | 外部中断1允许位          | 定时器T0溢出中断允许位 | 外部中断 INT0允许位      |
| EA=1，CPU开放中断 |      |      | ES=1，允许串行口中断 |   ET1=1，允许T1中断    | EX1=1，允许外部中断1中断 | ET0=1，允许T0中断      | EX0=1，允许外部中断0中断 |

（9）串行控制位SCON ==9FH~98H==

| D7             | D6             | D5                                     | D4               |                              D3                              | D2                                                           | D1                                                           | D0                                                           |
| -------------- | -------------- | -------------------------------------- | ---------------- | :----------------------------------------------------------: | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| SM0            | SM1            | SM2                                    | REN              |                             TB8                              | RB8                                                          | T1                                                           | R1                                                           |
| 工作方式选择位 | 工作方式选择位 | 多机通信控制位，主要用于方式2和方式3。 | 允许串行接收位。 | 在方式2或方式3中，是发送数据的第九位，可以用软件规定其作用。 | 在方式2或方式3中，是接收到数据的第九位，作为奇偶校验位或地址帧/数据帧的标志位。在方式1时，若SM2=0，则RB8是接收到的停止位。 | 串行口发送中断请求标志位                                     | 串行口接收中断请求标志位                                     |
|                |                |                                        |                  |                                                              |                                                              | 当发送完一帧串行数据后，由硬件置1，在转向中断服务程序后，用软件清0。 | 当接收完一帧串行数据后，由硬件置1；在转向中断服务程序后，用软件清0。 |

（10）定时器/计数器/串行数据

| 符号     | 地址 | 功能介绍                     |
| -------- | ---- | ---------------------------- |
| **TH1**  | 8DH  | 定时器/计数器1（高8位）      |
| **TH0**  | 8CH  | 定时器/计数器1（低8位）      |
| **TL1**  | 8BH  | 定时器/计数器0（高8位）      |
| **TL0**  | 8AH  | 定时器/计数器0（低8位）      |
| **SBUF** | 99H  | 串行口锁存器（两个，写和读） |

（11）中断优先级控制寄存器IP ==0BFH~0B8H==

| D7   | D6   | D5   | D4                                   |                  D3                  | D2                                   | D1                                   | D0                                   |
| ---- | ---- | ---- | ------------------------------------ | :----------------------------------: | ------------------------------------ | ------------------------------------ | ------------------------------------ |
| /    | /    | /    | PS                                   |                 PT1                  | PX1                                  | PT0                                  | PX0                                  |
|      |      |      | 串行中断优先级设定位                 |        定时中断1优先级设定位         | 外部中断l优先级设定位                | 定时中断0优先级设定位                | 外部中断0优先级设定位                |
|      |      |      | X =0,  优先级为低；X=1, 优先级为高。 | X =0,  优先级为低；X=1, 优先级为高。 | X =0,  优先级为低；X=1, 优先级为高。 | X =0,  优先级为低；X=1, 优先级为高。 | X =0,  优先级为低；X=1, 优先级为高。 |

（12）堆栈指针SP ==81H==

堆栈：只允许在其一端进行数据插入和数据删除操作的线性表。RST初始化为07H。

堆栈是为子程序调用和中断操作而设立的。

堆栈的功能：保护断点和保护现场，保护断点：  PC，保护现场：寄存器中的内容。

传送数据方式：入栈：PUSH 出栈：POP。堆栈操作的最大特点：“后进先出”。

堆栈要求：具有足够的容量（或者说足够的堆栈深度）。

堆栈开辟：

1）外堆栈：在主存储器中开辟堆栈．例如8080，Z80等早期的微型机。主要优点是堆栈容量大。但外堆栈的操作速度较慢。

2）内堆栈：在CPU芯片内部存储器中开辟。MCS－51的堆栈就是开辟在内部RAM中。
点是操作速度快，但堆栈容量有限。

堆栈使用方式：

1)：自动方式：（保护断点） 

在调用子程序或中断时，返回地址（断点）自动进栈。程序返回时，断点再自动弹回PC.

操作的特点：堆栈操作无需用户干预--  自动方式。

2)：指令方式（保护现场）

进栈指令:  PUSH出栈指令:  POP。

==递增满堆栈==

（13）汇总

| **符号** | **地址** | **功能介绍**                |
| -------- | -------- | --------------------------- |
| **B**    | F0H      | B寄存器                     |
| **ACC**  | E0H      | 累加器                      |
| **PSW**  | D0H      | 程序状态字                  |
| **IP**   | B8H      | 中断优先级控制寄存器        |
| **P3**   | B0H      | P3口锁存器                  |
| **IE**   | A8H      | 中断允许控制寄存器          |
| **P2**   | A0H      | P2口锁存器                  |
| **SBUF** | 99H      | 串行口锁存器                |
| **SCON** | 98H      | 串行口控制寄存器            |
| **P1**   | 90H      | P1口锁存器                  |
| **TH1**  | 8DH      | 定时器/计数器1（高8位）     |
| **TH0**  | 8CH      | 定时器/计数器1（低8位）     |
| **TL1**  | 8BH      | 定时器/计数器0（高8位）     |
| **TL0**  | 8AH      | 定时器/计数器0（低8位）     |
| **TMOD** | 89H      | 定时器/计数器方式控制寄存器 |
| **TCON** | 88H      | 定时器/计数器控制寄存器     |
| **DPH**  | 83H      | 数据地址指针（高8位）       |
| **DPL**  | 82H      | 数据地址指针（低8位）       |
| **SP**   | 81H      | 堆栈指针                    |
| **P0**   | 80H      | P0口锁存器                  |
| **PCON** | 87H      | 电源控制寄存器              |
> 注：SFR可以位寻址的要求为地址以0或8结尾。

#### 并行输入/输出端口结构

1、P0口

I/O口应用时：“控制”=0；数据/地址时：“控制”=1。

用作输入口时，需先给P0.x口输出高电平。MOV  P0， #0FFH



![P0口结构](https://img.tim-wcx.ltd/i/2022/06/07/629f3b307d160.png)

2、P1口

当用作输入时，必须先输出1；P1口为准双向口；外接电路一般采用共阳极。

![P1口结构](https://img.tim-wcx.ltd/i/2022/06/07/629f3b418eafb.png)

#### 时钟电路与CPU时序

时钟电路：用于产生单片机工作所需要的时钟信号；

时序：指令执行中各信号之间的相互关系。

1、时钟电路
(1) 内部时钟方式

​	芯片内部的高增益反向放大器和在引脚XTAL1和XTAL2两端跨接晶体振荡器和微调电容，就构成了一个稳定的自激振荡器，其发出的脉冲直接输入单片机的内部时钟电路。

(2)  外部时钟方式

​	HMOS和CHMOS型单片机的外部时钟电路

​	HMOS XTAL2--OUT时钟源 XTAL1---地

​	CHMOS XTAL2--悬空 XTAL1--OUT时钟源

2、CPU时序

MCS-51的时序定时单位共有4个，从小到大依次是：拍节，状态、机器周期、指令周期。

(1) 拍节与状态

拍节（P）：振荡脉冲的周期，又称振荡周期。

状态（S）:  时钟信号的周期，又称时钟周期。

关系：振荡频率＝2倍时钟频率

​            时钟周期＝2倍振荡周期，

 即  1S=2P（拍节1（P1），拍节2（P2））。

(2) 机器周期

机器周期: 指CPU访问存储器一次所需要的时间。例如取指令，读存储器、写存储器等。

MCS-51的一个机器周期包括12个振荡周期（12P）＝6S

 即6个状态：S1～S6。

而每个状态又分为两拍，称为P1和P2。

因此，一个机器周期中的12个振荡周期表示为S1P1、S1P2、S2P1……、S6P2。

(3) 指令周期

定义： 执行一条指令所需要的时间称之为指令周期。

最大的时序定时单位，无固定值。

指令不同，指令周期不同。

MCS-51的指令包含一、二、四个机器周期。

例如: 外接晶振频率fOSC为12 MHz时, MCS—51单片机的4个时间周期值为: 

​            振荡周期  P=1/fosc＝1/12 μs; 

​            状态周期  S=2P＝1/6 μs; 

​            机器周期  =6S＝12P＝1 μs;

​            指令周期  =1、2、4 μs。

3、典型指令的时序

根据指令代码所占的字节不同：单字节、双字节、三字节。

根据指令执行时间的不同：单机器周期、双机器周期四机器周期。

执行指令的两个阶段：取指令和执行指令。

ALE：地址锁存允许信号，每有效一次对应单片机进行的一次读指令操作， 取指有效时间：S1P2和S2P1，S4P2和S5P1。ALE出现频率为振荡脉冲频率的1/6。S1P2和S2P1为访问存储器取指、S4P2和S5P1为访问存储器执行读或写操作数。

#### 复位电路

1、复位： 单片机的初始化操作。

复位的功能：

（1） 进入系统的正常初始化； （PC）＝0000H， 单片机从0000H单元执行程序；

（2） 使系统摆脱困境。

复位信号要求：

高电平； 应持续24个振荡周期（即两个机器周期以上）。

| **SFR名称** | **初始状态**  | **SFR名称** | **初始状态**  |
| ----------- | ------------- | ----------- | ------------- |
| **ACC**     | **00H**       | **TMOD**    | **00H**       |
| **B**       | **00H**       | **TCON**    | **00H**       |
| **PSW**     | **00H**       | **TH0**     | **00H**       |
| **SP**      | **07H**       | **TL0**     | **00H**       |
| **DPL**     | **00H**       | **TH1**     | **00H**       |
| **DPH**     | **00H**       | **TL1**     | **00H**       |
| **P0~P3**   | **FFH**       | **SBUF**    | **不确定**    |
| **IP**      | **XXX00000B** | **SCON**    | **00H**       |
| **IE**      | **0XX00000B** | **PCON**    | **0XXX0000B** |

2、掉电保护方式

数据转存：数据转存是通过中断服务程序完成的，即通常所说的“掉电中断” 。

接通备用电源：备用电源由单片机的RST/VPD引脚接入，要求系统中具有备用电源与电源电压的自动切换电路 。 

3、低功耗工作方式 （由PCON中的PD和IDL控制）

空闲模式(待机模式) 掉电保护模式(休眠模式)

#### 小结

8051单片机由8位微处理器、128B数据存储器、4KB掩膜程序存储器、4个8位并行I/O口、1个串行口、2个16位的定时/计数器以及特殊功能器等构成。

4个8位并行I/O口是P0、P1、P2和P3口。P1口是唯一的单功能口，仅能作通用的数据I/O口使用，P0、P2和P3口均有第二功能。

8051单片机的时钟电路有内部时钟和外部时钟二种方式。晶振周期(拍节)、时钟周期(状态)、机器周期和指令周期是单片机的基本时序单位。

复位操作使单片机进入初始化状态。复位操作有上电自动复位和按键手动复位两种方式。复位后，程序计数器PC为0，P0～P3为0FFH，SP为07H，SBUF不定，IP、IE和PCON的有效位为0，其余特殊功能寄存器的状态均为0。

### 第4章 MCS-51的指令系统

#### 计算机语言

（1）机器语言:是用二进制代码表示的，能被计算机直接识别和执行的一种机器指令的集合。

优点：灵活、能被计算机直接执行、速度快等。 

缺点：直观性差，很容易出错，通用性很差。

（2）汇编语言：是一种用助记符表示的仍然面向机器的计算机语言，又将其称为符号语言。

优点：用符号代替了机器指令代码，简化了编程过程，而且助记符与指令代码一一对应，基本保留了机器语言的灵活性。占用的内存空间少，运行速度快。      

缺点： 必须对编写的程序进行加工和翻译，才能变成能够被计算机识别和处理的二进制代码程序。仍然是面向机器的语言，使用起来还是比较繁琐费时，通用性差。

用汇编语言等非机器语言书写好的符号程序称汇编语言源程序。

（3）高级语言：与自然语言相近并为计算机所接受和执行的计算机语言称为高级语言，它是面向用户的语言。

优点：编程容易，不需要编程者对机器硬件有较好的了解。

缺点：执行速度比机器语言和汇编语言慢。

#### 汇编语言程序语句格式

1、汇编指令由操作码或伪操作码、目的操作数和源操作数构成，标准书写格式如下：

[标号:]   操作码/伪操作码  [操作数]  [；注释]

标号：又称指令地址符号。它是用户设定的符号，代表着该条指令所在的地址。标号必须以字母开头，其后跟1~8个字母或数字，并以“：”结尾。标号不能为指令系统中的指令助记符、CPU的寄存器名以及伪指令等，且同一程序内标号必须互不相同。 

操作码/伪操作码：是用英文缩写的指令助记符。

操作码：规定了指令的操作功能，它所对应的汇编语句称为指令性语句。	

如：MOV  50H，#10H

机器码：75H，50H，10H。

伪操作码：说明汇编程序如何完成汇编工作，它所对应的语句称为指示性语句，在汇编后没有目标代码。

如：ORG， END， EQU 等。 

操作数：指参加操作的数据或数据所在的地址。在MCS-51单片机中，操作数可以是1、2、3个，也可以没有。

规定：操作码/伪操作码和操作数之间必须用空格分开，操作数与操作数之间必须用逗号分开。

注释：增加程序的可读性，以“；”号开头。 

2、操作数的类型

立即数 #30H

寄存器操作数 A，R0

存储器操作数 20H

3、MCS-51系列单片机指令格式及分类

单字节指令、双字节指令、三字节指令

4、MCS-51汇编语言伪指令

4.1 ORG（Origin）  汇编起始地址命令

功能：用于规定目标程序的起始地址。

[标号：]  ORG   地址

地址项：16位绝对地址，也可以用标号或表达式表示。       

一个源程序中，可多次使用ORG指令以规定不同程序段的起始位置。地址应从小到大顺序排列，不允许重叠。

4.2 END（END of assembly）汇编终止命令            

功能：用于终止源程序的汇编工作。

格式：  [标号：]   END   [表达式]

注意：只有主程序模块才有“表达式” 项，且“表达式”的值等于该程序模块的入口地址。而其他程序模块就没有“表达式”项。“标号：”也是选择项。

一个源程序只能有一个END命令。

4.3 DB（Define Byte）  定义数据字节命令

功能：用于从指定的地址单元开始，在程序存储器中定义字节数据。    

```assembly
ORG	 8100H
TAB： DB  	0C0H,  0F9H,  0A4H,  0B0H
```

4.4 DW（Define Word）	定义数据字命令

功能：用于从指定地址开始，在程序存储器单元中定义16位的数据字。

存放规则：高8位在前（低地址），低8位在后（高地址）。

```assembly
ORG  1100H
DATA2:  DW	   3478H, 10H, -1
```

注意：DB和DW定义的数表，数的个数不得超过80个。如果数据的数目较多时，可使用多个定义命令。在 MCS-51程序设计应用中，常以DB定义数据，以DW定义地址。

4.5 DS（Define Storage）  定义存储区命令

功能：用于从指定地址开始，保留指定数目的字节单元为存储区，供程序运行使用。汇编时对这些单元不赋值。

格式：         [标号：]      DS      16位数表

```assembly
ORG   8100H
DS    08H
```

注意：对MSC-51单片机来说，DB、DW、DS命令只能对程序存储器使用，不能对数据存储器使用。

4.6 EQU（Equate）  赋值命令

功能：用于给字符名称赋予一个特定值。赋值以后，其值在整个过程中有效。

格式：字符名称    EQU    赋值项

“赋值项”：可以是常数、地址、标号或表达式。 

4.7 DATA  数据地址赋值命令

格式：字符名称    DATA   项

功能：与EQU基本类似，但有以下差别。

EQU定义的字符名称必须先定义后使用，而DATA定义的字符名可以先使用后定义。

用EQU可以把一个汇编符号赋给字符名称，如上例中的R1，而DATA只能把数据赋给字符名。

4.8 BIT   位定义命令

功能：    用于给字符名称赋以位地址。

格式：    字符名称    BIT    位地址

其中“位地址”可以是绝对地址，也可以是符号地址。

#### 寻址方式

寻址：获得操作数所在的地址的方法。

7种寻址方式：立即寻址、寄存器寻址、直接寻址、寄存器间接寻址、基址加变址寻址、相对寻址、位寻址。

1、立即寻址

指令中直接给出操作数的寻址方式。

立即数：8位或16位。

2、直接寻址

指令中直接给出操作数所在地址的寻址方式。

操所数所在区域：

（1）==内部RAM的低128单元；==

（2）特殊功能寄存器。

3、寄存器寻址

以通用寄存器的内容为操作数的寻址方式。

例如：MOV  20H，A 		； 20H ←（ A ）

可用的寄存器：通用寄存器R0~R7和若干SFR，例如，A，B和DPTR。

其中B仅在乘除法指令中为寄存器寻址，在其他指令中为直接寻址。A既可以是直接寻址，也可以是寄存器寻址。 

直接寻址和寄存器寻址的差别在于直接寻址是以操作数所在的单元地址(占一个字节)出现在指令码中，而寄存器寻址是寄存器编码出现在指令码中。由于可用作寄存器寻址的寄存器少、编码位数少(少于三位二进制数)，通常操作码和寄存器编码合用一个字节，因此寄存器寻址的指令机器码短，执行快。

4、寄存器间接寻址

以寄存器中的内容为地址，以该地址中的内容为操作数的寻址方式称为寄存器间接寻址。

可用的寄存器：R0、R1和DPTR。

MOV	A，＠R0	；A←((R0))

寄存器间接寻址的寻址范围为片内RAM和片外RAM。

寄存器间接寻址的寻址范围：片内RAM和片外RAM。

当寻址片内RAM时，使用R0或R1作间址寄存器，其通用形式为 @Ri（i=0或1） 。

当寻址片外RAM时，使用DPTR作间址寄存器，其通用形式为 @DPTR。

5、变址寻址(或基址加变址寻址)

以DPTR或PC作基址寄存器，累加器A作变址寄存器，并以两者内容相加形成的16位地址作为操作数地址的寻址方式称为变址寻址，或基址加变址寻址方式。

寻址空间：==程序存储器ROM。==

指令：MOVC

变址寻址方式只能对程序存储器进行寻址，或者说它是专门针对程序存储器的寻址方式。

变址寻址的指令只有三条

MOVC 	A，＠A＋DPTR   MOVC 	A，＠A＋PC    JMP 	＠A＋DPTR

其中前两条是程序存储器读指令，后一条是无条件转移指令。

尽管变址寻址方式操作较为复杂，但变址寻址指令都是一字节指令。 

6、相对寻址 

寻址方式主要用于通过修改PC值而实现程序的分支转移。 

在汇编语言中，相对转移指令后给出的地址即为程序的目标地址. 

注意: 在机器语言中相对转移指令指令代码后跟的不是汇编语言中给出的目标地址，而是该目标地址和程序计数器PC的当前值（指跳转指令的下条指令的地址）之间的相对偏差rel。 

7、位寻址方式

在进行位操作时，借助于进位位C作为操作累加器。

对于特殊功能寄存器中具有位地址和位名称的位，可以采用以下四种方法表示.

(1) 位名称表示方法：CLR  CY

(2) 位地址表示法：CLR  0D7H

(3) 单元地址加位的表示方法：CLR  0D0H.7 

(4) 专用寄存器符号加位的表示方法：CLR  PSW.7

注：源操作数和目的操作数各有自己的寻址方式。			MOV	50H， R1

源操作数：寄存器寻址方式，

目的操作数：直接寻址方式，

指令的功能：把按寄存器寻址取出的R1内容再以直接寻址方式存放于内部RAM的50H单元中。

#### 指令系统

五大类：数据传送类指令、算术运算类指令、逻辑运算及移位类指令、控制转移类指令位操作类指令。

1、数据传送类指令

指令功能：一般是把源操作数传输到目的操作数，指令执行后，源操作数不变，而目的操作数修改为源操作数。 

对外部RAM数据传送指令作如下说明：

①  外部数据存储器数据传送指令就是外部RAM的读写指令。

②  外部RAM数据传送指令与内部RAM数据传送指令的助记符不同。

​	内部RAM：MOV，

​	外部RAM：MOVX。    增加的“X”表示外部之意。

③ 外部RAM传送，只能通过累加器A进行。 

MOX 外部RAM

MOV 内部RAM

MOVC  A，@A+PC；PC的查表范围在256B内，称近程查表。

MOVC  A，@A+DPTR	；DPTR可指向64KB空间，称远程查表。

整字节交换指令 XCH

半字节交换指令 XCHD

累加器高低半字节交换指令 SWAP

PUSH 	direct    ；SP←（SP）+1，（SP）←（direct）

POP 	direct    ；direct←((SP))，SP←（SP）－1

注意：使用堆栈前，需设定SP的初始值。

寻址方式： 以SP为间址寄存器的间接寻址方式。

> 注：数据传送类指令一般不影响程序状态字PSW， 但堆栈指令（PUSH和POP）可以直接修改状态字PSW。

2、算术运算类指令

2.1 加法指令组（ADD）

加法运算影响PSW位的状态。如果位3有进位，则辅助位标志AC置1，否则AC清0；如果位7有进位，则进位标志CY置1，否则CY清0。两个带符号数相加，还有溢出的问题。如果运算结果使溢出标志OV置1，则表示有溢出出现。

2.2 带进位加法指令组

三个数参加运算：累加器A，不同寻址方式的加数，以及==进位标志位CY==，运算结果送累加器A。

2.3 带借位减法指令组

SUBB 	A，Rn    	； A←（A）－（Rn）－==（CY）==

若进行不带借位的减法运算，需用CLR  C 把进位标志位清0即可。

带借位减法指令影响PSW的状态:

如果位3有借位，则AC置1，否则清0；

如果位7有借位，则CY置1，否则CY清0；

另外，两个带符号数相减也有溢出的问题，如溢出，则OV置1，否则，清0。

2.4 加1/减1/乘除指令组

==INC  	DPTR==

加1指令的操作不影响程序状态字PSW的状态, 除INC A对P外。p <--> 奇偶校验位

减1指令的操作不影响程序状态字PSW的状态, 除DEC A对P外。

51指令系统中，只有数据指针DPTR加1指令，而没有DPTR减1指令。

若乘积 < 0FFH（即（B）=0），则OV＝0，否则OV＝1，该运算总使CY＝0。

当除数为0（B＝0）时，OV＝1，表明除法无意义，无法进行；其它情况下， OV＝0。任何情况下， CY＝0。

乘除法运算影响PSW的状态。

2.5 十进制调整指令：

DA  	A

```assembly
MOV	A, #48H
ADD	A, #79H
DA	A;  A == #27H
```

一个十进制数用四位二进制编码表示，即二进制编码的==十进制数==，简称BCD码。

BCD码的修正（了解）

 (1) 如果任何两个对应位BCD数相加的结果向高一位无进位时，若得到的结果小于或等于 9，则该位不需修正；若得到的结果大于 9 且小于 16 位，则该位进行加 6 修正。      

 (2) 如果任何两个对应位BCD数相加的结果向高一位有进位时(即结果大于或等于 16)，该位进行加 6 修正。      

 (3) 低位修正结果使高位大于 9 时， 高位进行加 6 修正。

3、逻辑运算及移位类指令

3.1 逻辑与运算指令组

累加器A循环左移指令  RL  A    	

累加器A循环右移指令 RR  A 

累加器A带进位循环左移指令 RLC  A

累加器A带进位循环右移指令 RRC  A   

3.2 跳转指令

间接转移指令

 JMP    @A+DPTR   	 ；PC←（A）+（DPTR）

该指令可代替众多的判别跳转指令，具有散转功能（又称散转指令）。键盘译码程序就是本指令的一个典型应用。

3.3 位操作指令

在MCS-51中没有专门的数值比较指令，两个数的数值比较可利用这四条指令执行后CY的状态来判断数值大小。

若（CY）＝0，则左操作数＞右操作数

若（CY）＝1，则左操作数＜右操作数

> 注：CJNE可配合JC和JNC使用判断正负。

两个寻址位间不能实现直接传送。

### 第5章   MCS-51的汇编语言程序设计 

汇编语言程序共有四种结构形式：顺序结构、循环结构、分支结构和子程序结构。

#### 查表指令

```assembly
	 ORG 0
	 MOV	A，30H     
	 MOV DPTR，#TAB		；地址修正
	 MOVC A，@A+DPTR		
	 MOV 31H，A			；双字节指令
TAB：DB 3FH，06H，5BH，4FH，66H；字形代码表
     DB 6DH，7DH，07H，7FH，6FH 
     END
```

> 注：JBC指令
>
> JBC bit NEXT
>
> 单片机指令，检测某个位是否为1，若为1，则清零，并跳转到NEXT，若为零，则执行下一条语句。

#### 散转指令

JMP  @A+DPTR

```assembly
		MOV	DPTR，#TAB
		JMP	@A+DPTR
		NOP
TAB：	AJMP	  ADDM		；散转表
		AJMP	  SUBM
		AJMP	  MULM
		AJMP	  DIVM 
```

在使用JMP  @A+DPTR构成多分支程序时的注意事项：

① 由于A是8位寄存器，如果分支程序的个数大于128，则地址修正值大于256。为了获得正确的地址，需对数据指针的高8位DPH进行修正。

② 散转点数不得超过256，这是由A的容量确定的。

③ AJMP指令的跳转范围为2KB，这就限制了各分支程序的入口地址和转移表首地址TAB位于同一个2KB的空间范围内。为了克服这种局限，可以采用LJMP指令。

#### 子程序结构：

指令： RET或RETI。

注意事项：

（1）子程序有自己的名字;

（2）保护现场和恢复现场；

（3）正确地传递参数；

（4）子程序和主程序是相对的两个概念。

### 第7章  中断系统

#### 单片机中I/O传送方式

三种控制方式：

1）无条件传送方式 2）查询方式 3）中断方式

1、无条件传送方式

MOV P1, #30H; MOV A, P1

适用范围：

（1）具有常驻的或变化缓慢数据信号的外部设备，

（2）工作速度非常快，足以和CPU同步工作的外部设备。 例如：数/模转换器DAC。

2、程序查询方式

特点：输入输出完全由CPU控制；硬件电路比较简单。

缺点：浪费CPU的时间。

3、中断方式

中断方式与查询方式的主要区别在于：如何知道外设是否为数据的传送作好了准备。

查询方式是CPU的主动形式，而中断方式则是CPU等待通知（中断请求）的被动方式。

3.1 中断的基本概念

 指CPU在处理某件事情的时候，外部发生了某一事件请求CPU迅速去处理，于是CPU暂时中断当前的工作，转入处理所发生的事件，中断访问处理完后，再回到原来被中断的地方，继续原来的工作的过程称为中断。

中断系统（中断机构）；实现中断功能的部件

中断源：产生中断的请求源。

五个中断源：2个外部中断， INT0和INT1、2个定时/计数器中断， T0和T1、1个串行中断。

3.2 中断优先级

 CPU必须具备区分哪个中断源更为重要，从而确定优先处理哪个事件的能力，这就是中断优先级。
一般根据中断源的轻重缓急排队，优先处理最紧急事件的中断请求。

MCS-51系列单片机中，中断源有两个优先级，即低优先级和高优先级。

3.3 中断嵌套

当CPU正在处理某一中断请求时，又有优先级别更高的中断源发出中断请求，则CPU中止正在进行的中断处理程序，转去处理优先级更高的中断请求。待处理完后，再继续执行被中止了的中断处理程序，这样的过程称为中断嵌套，该中断系统称为多级中断系统。没有中断嵌套功能的中断系统称为单级中断系统。

3.4 中断的允许与禁止

当CPU正在执行主程序时，某个中断源发出中断请求，如果CPU接受该中断而转去处理中断服务程序，则称CPU允许此中断或开中断。如果有中断请求，但CPU并不接收此中断，则称CPU禁止中断、屏蔽中断或关中断。

#### 中断系统结构及中断控制

1、中断系统结构和中断源

![image-20220613193548672](https://img.tim-wcx.ltd/i/2022/06/13/62a7211ae3c80.png)

当IT0=0时，外部中断程序位电平触发方式，低电平有效，当IT0=1时，外部中断为脉冲触发方式，负跳变时有效。

中断优先级是为中断嵌套服务的，MCS—51中断优先级的控制原则是：

①  低优先级中断请求不能打断高优先级的中断服务；但高优先级中断请求可以打断低优先级的中断服务，从而实现中断嵌套。

②  如果一个中断请求已被响应，则同级的其它中断响应将被禁止。

③  如果同级的多个中断请求同时出现，则按CPU设定的自然优先级确定那个中断请求被响应。其自然优先级由高到低依次为：外部中断0→定时中断0→外部中断1→定时中断1→串行中断，这其实是CPU查询各中断的次序。

中断响应过程  

MCS-51单片机的CPU在每个机器周期的S5P2时刻采样中断标志。当发现有中断请求时，首先将这些中断请求锁存在各自的中断标志位中，并在下一个机器周期的S6期间查询所有中断标志，同时按照优先级由高到低排队，之后判断是否满足中断响应的条件，若满足，则在下一个机器周期S1期间按照优先级进行中断处理。

响应中断的条件 

① 该中断源发出中断请求；

②  CPU开中断，即中断总允许位EA=1；

③ 申请中断的中断源的中断允许位为1，即该中断没有被屏蔽；

④ 无同级或是更高级中断正在被服务。 

中断响应过程被阻断的条件

①  同级或高优先级的中断已在进行中； 

②  当前的机器周期还不是正在执行指令的最后一个机器周期。也就是说，正在执行的指令完成前，任何中断请求都得不到响应；

③ 正在执行的是一条RET或RETI，或者访问特殊功能寄存器 IE或 IP的指令。执行这些指令之后，不会马上响应中断请求，至少要执行一条其它指令之后才能响应中断。 

响应中断后，硬件完成的功能：

① 根据响应的中断源的中断优先级，使相应的优先级状态触发器置1； 

② 调用中断服务子程序, 并把当前程序计数器PC的内容压入堆栈；

③ 清除相应的中断请求标志位（串行口中断请求标志RI和TI除外）；

④ 把被响应的中断源所对应的中断服务程序的入口地址送入PC，从而执行中断服务程序。 

中断响应时间:  3~8个机器周期.

主程序的初始化：

初始化包括：相应中断源开中断；设定所涉及中断源的中断优先级；若为外部中断，应规定其触发方式。

中断服务程序的最后一条指令是RETI。

#### 定时/计数器的结构和寄存器

定时/计数器的原理结构框图

![image-20220613203434496](https://img.tim-wcx.ltd/i/2022/06/13/62a72ee00951c.png)

1、定时/计数器的定时和计数功能

定时计数器的功能：定时和计数

1）计数功能

计数：对外部事件进行计数。外部事件的发生以输入脉冲表示。

计数输入端：T0（P3.4）和T1（P3.5），脉冲在负跳变时计数器加1（**加法计数**）。

2）定时功能

实现方法：通过计数器的计数实现。

与计数功能的不同之处：

计数脉冲来自单片机的内部，即每个机器周期产生一个计数脉冲，即每个机器周期计数器加1。      

若：单片机晶振＝6MHz，机器周期为2微秒。

2、定时器/计数器的初始化

将控制字写入定时器/计数器的过程叫定时器/计数器的初始化。

初始化内容：

规定T0、T1的工作方式；  规定T0、T1的工作状态； 赋定时/计数初值。

3、定时/计数器初值的确定

定时器/计数器以加1方式计数，假定要求的计数长度为N，则应装入定时器/计数器的初值$X＝2^{13}－N$。

4、写入控制字的次序：

​	1） 把工作方式控制字写入TMOD寄存器；

​	2）把定时/计数初值装入TL0、TH0（或TL1、TH1）；

​    3）置位ET0（或ET1）允许定时器/计数器中断（如果需要）；

​	4）置位EA使CPU开放中断。

​	7）置位TR0（或TR1）以启动计数

5、方式0

![image-20220613214247617](https://img.tim-wcx.ltd/i/2022/06/13/62a73ed82f58d.png)

6、方式1

![image-20220613214227133](https://img.tim-wcx.ltd/i/2022/06/13/62a73ec8d05ad.png)

7、方式2

![image-20220613214522208](https://img.tim-wcx.ltd/i/2022/06/13/62a73f7722b19.png)

8、方式3下，T0和T1的 工作的设置和使用是不同的。

![image-20220613214902047](https://img.tim-wcx.ltd/i/2022/06/13/62a740533de5c.png)

T0的各控制位、引脚和中断源，即GATE、TR0、TF0、C/T和T0（P3.4）引脚、INT0（P3.2）引脚全归TL0使用。其功能和操作与方式1或0完全相同。

所以：在工作方式3下，T0被拆成两个独立的8位计数器TL0和TH0。其中TL0既可以作计数使用，又可以作定时使用。

TH0只好借用定时器/计数器1的控制位TR1和TF1，即以计数溢出去置位TF1，而定时的启动和停止则受TR1的状态控制。

所以：方式3下T0可以作两个8位的定时器或一个定时器和一个计数器。

工作方式3下的T1

​	如果T0已工作在工作方式3，则T1只能工作在方式0、1或方式2下，它的运行控制位TR1及计数溢出标志位TF1已被T0借用。

![image-20220613215415707](https://img.tim-wcx.ltd/i/2022/06/13/62a7418c4e6fc.png)

此时，T1通常是作为串行口的波特率发生器使用，以确定串行通信的速率。因为已经没有计数溢出标志位TF1可供使用，因此只能把计数溢出直接送给串行口。若将T1强行设置为模式3，就会使T1立即停止工作。

9、门控位的应用举例

当门控位GATE=1时，如果TR0（TR1）=1且/INT0（/INT1）=1才能启动定时/计数器，当/INT0（/INT1）=0时又使定时/计数器停止。可利用这一特性测量外部输入脉冲的宽度。

#### 小结

在定时方式下被计对象是单片机内部的机器周期数；而在计数方式下，被计对象是外部事件的数量（由高电平到低电平的边沿数）。

无论是定时还是计数，当计数器溢出时会自动置位TF0或TF1。在查询方式下可以通过检查TF的状态判断是否计满；在允许中断的情况下，CPU自动进入中断服务程序。采用中断方式可大大提高CPU的利用率。

