# 计算机操作系统复习

### 第零章 绪论

1. 操作系统是一种规模较大、复杂性高的系统软件。

2. 操作系统做什么？

   1. 为应用程序开发提供平台 2. 为应用程序运行提供支持：提供、资源管理、驱动硬接口件。

3. 操作系统原理/OS设计与实现原理？

   功能、与硬件的接口、算法、数据结构、策略。

4. 操作系统 是如何被装入内存并开始运行的？

   BOOT->LOADER->KERNEL

5. 当你点击word的“存盘”时，你的数据是如何由内存传入磁盘？为什么你给出路径和文件名就可以得到你需要的文件内容？

   打开一个word文档是指把该文档从磁盘调入到内存并显示，文件系统。

6. 你桌面上的时钟每隔一分钟会刷新一次，怎么实现的？

   时钟中断，具体为，PIT(可编程间隔定时器) ---时钟中断---> PIC (可编程中断控制器)  ---电信号、时钟中断向量--> CPU ---> 时钟中断处理程序。

7. 对一个大规模矩阵，按行遍历快还是按列遍历更快？为什么？一个应用程序的时间性能可以通过哪些环节的改善得以提高？

   看操作系统，按行优先还是按列优先。

   降低时间复杂度，提高程序的局部性。

8. 网络数据包的发送和接收是如何实现的？

   参考链接：[Linux 数据包的接收与发送过程](https://morven.life/posts/networking-1-pkg-snd-rcv/)


> 注：CPU上下文环境是指保证程序能正常运行而需要从内存恢复到CPU中寄存器的值。
>
> 磁盘块是指$2^n$个连续扇区，扇区大小一般为512字节。

### 第一章 操作系统概述

#### 1 什么是操作系统

1、操作系统是用户与计算机硬件之间的接口

屏蔽控制硬件的细节，使应用程序的开发更简单、高效

1.2 接口形式：命令行接口、图形用户接口、系统调用

1.3 文件的存放

1.3.1 逻辑地址和物理地址

逻辑地址：簇号或扇区的逻辑编号。

物理地址：柱面号、磁头号（磁道号）、扇区号。

逻辑地址转为物理地址依赖于文件系统和设备驱动程序。

1.3.2 磁盘读文件的过程

1）用户给出文件名，提出访问文件的请求

2）文件系统通过按名访问机制获取文件的逻辑地址（磁盘块号或扇区编号）[OS完成]

3）磁盘驱动程序将逻辑地址转换为物理地址、发送磁盘操作指令 [OS完成]

2、操作系统是计算机资源的管理者

管理：处理机、内存、设备、文件、网络等。

2.1 操作系统的设计追求的主要目标

1）方便用户（最终用户和程序员）

2）提高系统性能：空间性能、时间性能、资源利用率 

#### 2 操作系统的发展

1、无操作系统 

定义：第一代计算机（1945-1955）使用电子管作为主要的电子器件，用插件板上的硬连线或穿孔卡表示程序，没有存储程序的内存，无操作系统。

2、单道批处理系统 

定义：单道批处理系统内存中只有一道作业，可以成批处理作业。克服CPU因等待人工操作造成的资源浪费问题

特点：①自动性  ②顺序性  ③单道性

优点：减少等待人工操作的时间

缺点： ①作业独占CPU ②CPU等待I/O使得CPU利用率低（相对于多道程序系统而言）    

3、多道程序系统

3.1 多道批处理系统

特点：①多道性  ②无序性 ③调度性 ④复杂性

优点：①提高CPU利用率 ②提高内存和I/O利用率 ③增加系统吞吐量

缺点： ①平均周转时间   ②缺乏交互能力

3.2 分时系统

连续的时间片轮流交替使用。

定义：①人机交互   ②共享主机  ③便于用户上机

特点：①多路性 ②独立性 ③及时性 ④交互性

优点：①提供人机交互 ②多终端共享主机

分时系统实现中的关键问题：

①及时接收：及时接收用户的命令或数据

②及时处理：及时处理用户命令。应该使所有的用户作业都直接进入内存；在很短的时间内使每个作业都得到运行。

4、微机操作系统 

5、实时操作系统 

定义：实时系统是支持实时计算的系统。实时计算可以定义成这样一类计算，既系统的正确性不仅取决于计算的逻辑结果，而且还依赖于产生结果的时间。

特点：①多路性 ②独立性 ③及时性 ④交互性 ⑤可靠性

实时任务的类型 ①周期性实时任务 ②非周期性实时任务 ③硬实时任务  ④软实时任务。

> 注：一个实际的OS可以同时具有批处理、分时和实时的特点，如Windows NT。
>

吞吐量是指单位时间内系统处理的作业量/任务量。

事件的开始截止时间，完成截止时间。

作业：在计算机操作系统中，作业(Job)是计算机操作员(或称为作业调度程序的程序)提供给操作系统执行任务的工作单元，一系列程序+数据的集合。

#### 3. 操作系统的特征

并发：两个或多个事件在同一时间间隔内发生。并发强调“同一时间间隔”，与并行是不同的两个概念，并行是指多个事件同时发生。

共享：系统中的资源可供内存中多个并发执行的进程共同使用。 资源共享有两种方式，即：互斥共享和同时共享。

虚拟：通过某种技术把一个物理实体变成若干逻辑上的对应物。

异步：进程以不可预知的顺序、进度运行，系统能处理随机发生的事件。

#### 4 操作系统的功能

内存管理功能、进程管理功能、设备管理功能、文件管理功能、用户接口

1、内存管理功能

内存分配;

内存保护: 确保每道用户程序都在自己的内存空间中运行，互不干扰。

地址映射;

①逻辑地址和物理地址

一个应用程序经编译后，通常会形成若干个目标程序，这些目标程序再经过链接而形成可装入程序。这些程序的地址都是从某一起始地址开始的，程序中的其它地址都是相对于起始地址计算的；由这些地址所形成的地址范围称“地址空间”，其中的地址称为“逻辑地址”。

由内存中的一系列单元所限定的地址范围称为“内存空间”，其中的地址称为“物理地址”。

②地址映射

内存扩充；虚拟内存。

内存回收：程序执行完毕或文件被关闭，系统将程序、文件占用的内存空间标记为空闲状态。

2、进程管理功能

进程控制

进程同步

进程通信

进程调度

3、设备管理功能

缓冲管理：管理各种缓冲区。

设备分配：分配用户I/O 所需要的设备。

设备处理：由设备驱动程序来实现CPU与设备控制器之间的通信。

设备独立性：应用程序与具体的物理设备无关。

虚拟设备：多个用户、多个进程课共享同一个物理设备。

4、文件管理功能

文件的按名访问

文件的存储

5、提供用户接口

命令接口

图形接口：采用图形化的操作界面。

程序接口：由一组系统调用组成。

#### 5 指令的执行

1、取指令与执行指令

1.1 取指令

在每个指令周期开始的时候，处理器从存储器中取一条指令，在典型的处理器中，程序计数器（PC）保存有下一次要取的指令的地址。除非接收到别的指示（如执行跳转指令），否则处理器在每次完成取指令后总是对PC递增，使它能够按顺序取得下一条指令。（即位于下一个高端存储器地址的指令）。

1.2 执行指令

取到的指令被放置在处理器中的指令寄存器（IR中。指令中包含确定处理器将要采取动作的位，处理器解释指令并执行要求的操作，这些操作可分为4类：

①处理器-存储器:数据在存储器和处理器之间传送；   

②处理器-I/O：数据在I/O设备和处理器之间传送；

③数据处理：算术操作或逻辑操作；

④控制：修改指令的执行顺序。

2、内部CPU寄存器

程序计数器（PC）----存指令地址

指令寄存器（IR) ----存正在执行的指令

累加器（AC)     ----临时存储体和累加操作

#### 6 小结

1. 程序执行的过程是反复取指令和执行指令的过程；

2. PC始终存有下一条待取指令的地址；

3. 指令执行的结果就是使寄存器或内存单元的值发生变化。指令执行的过程也就是存储体内容不断变化的过程。

4. 取指令和执行指令是由硬件完成的。

5. 不同硬件的体系结构支持不同的指令集合，为某种硬件平台开发的操作系统不能直接在另一种体系结构的硬件上运行。

6. 任何高级语言程序被编译成指令集合，其中的每一条指令属于机器体系结构指令集。CPU执行的最小程序单位是指令而不是高级语言程序的语句。

7. 操作系统是一组控制和管理计算机硬件和软件资源、合理地对各类作业进行调度以及方便用户的程序集合。

8. 说明逻辑地址对于程序的自动执行而言有什么意义？逻辑地址的存在使得编译器能够忽略不同操作系统和硬件的差异并且只针对统一的编址空间执行优化。

9. 以printf的执行为例说明操作系统提供了应用程序开发的方便性、操作系统屏蔽了硬件细节的作用。

   封装调用系统调用，sys_print()系统调用并返回。

10. 请简要说明操作系统为应用程序的执行做了哪些工作？

    操作系统到外存查找可执行文件

    操作系统分配内存，将程序装入内存

    为执行hello程序创建执行环境（创建新进程）

    操作系统设置CPU上下文环境，并跳到程序开始处

    程序的第一条指令执行

    程序执行与printf对应的库函数、系统调用

    执行显示驱动程序

    将像素写入存储映像区(显存）

11. 操作系统具有哪些特征？什么是并发？什么是共享？它们有什么关系？

    并发性（Concurrence）

    并行性和并发性是既相似又有区别的两个概念。并行性是指两个或多个事件在同一时刻发生，而并发性是指两个或多个在同一时间间隔内发生。在多道程序环境下，并发性是指宏观上在一段时间内有多道程序在同时执行。但在单处理机系统中，每一个时刻CPU仅能执行一道程序，故微观上，这些程序是在CPU上交互执行。

    共享性（Sharing）

    共享是指系统中的所有资源不再为一个程序所独占，而是供同时存在于系统中的多道程序所共同使用。根据资源属性不同，可有互斥共享和同时共享两种不同的共享方式。
    并发和共享关系：

    并发和共享是操作系统的两个最基本的特性，它们又是互为存在条件。一方面资源共享是以程序（进程）的并发性执行为条件的，若系统不允许程序并发执行，自然不存在资源共享问题。另一方面若系统不能对资源共享实施有效管理，则也必将影响到程序并发执行。

### 第二章 进程的描述与控制

#### 1 程序的并发运行

1 概念

在同一时间间隔内运行多个程序，一个程序还没有执行完，可以运行其它的程序，对用户而言，看到的是计算机同时运行多个程序。

程序并发执行的方式可以是多个程序分时使用多CPU或单CPU。 

2 特点

①间断性 ②多个程序共享系统资源（失去封闭性）③不可再现性 

#### 2 进程的描述

进程概念的引入是为了跟踪并描述程序的并发执行。当允许程序并发执行时，并发执行的程序可能是同一个程序在不同数据集合上的执行，也可能是不同的程序在不同数据集合上的执行，它们共享系统资源，用程序已不能方便地描述程序的并发执行，所以引入了进程的概念 。

1 进程的定义

定义1：进程是允许并发执行的程序在某个数据集合上的执行过程。

定义2：进程是由用户数据、系统数据和程序构成的实体。

2 进程的特征

并发性：多个进程实体，同存于内存中，能在一 段时间内同时运行。 

动态性：进程是进程实体的执行过程，对应了存储体的不断变化；有创建、执行、状态变化和运行终止被撤消的过程

独立性：独立运行和资源调度的基本单位。

异步性：以不同的、不可预知的速度向前推进。

结构特征：进程包括用户数据、程序、系统数据。

3 进程与程序的比较

区别 ：

①程序是静态的概念，进程是动态的概念 

②程序是永久的，进程是暂时存在的 

③程序与进程的存在实体不同 

联系 ：

①进程是程序的一次执行，进程总是对应一个特定的程序，执行程序的代码，一个进程必然对应至少一段程序。

②一个程序可以对应多个进程。同一个程序段可以在不同的数据集合上运行，因而构成若干个不同的进程。

4 程序控制块

进程控制块是进程实体的一部分，**与进程一一对应**，是操作系统中最重要的记录型数据结构，PCB中记录了操作系统所需要的用于描述进程情况及控制进程运行所需的全部信息，**只有内核程序可以直接访问**。

4.1 进程控制块中的信息

1） 进程标识符信息

 ① 外部标识符 ② 内部标识符 ③ 父进程标识符 ④子进程标识符

2）处理机状态信息

①通用寄存器 ②指令计数器 ③程序状态字PSW ④用户栈指针

3）进程调度信息
①进程状态信息 ②进程优先级 ③进程调度所需要的其他信息 ④事件

4）进程控制信息
①程序和数据的地址 ②进程同步和通信机制 ③资源清单 ④链接指针

#### 3 Linux的进程控制块

Linux PCB大小为8KB

#### 4 进程控制

1、进程的基本状态

1.1 进程的三种基本状态

 就绪状态：进程一但获得CPU就可以投入运行的状态。

 执行状态：进程获得CPU正在运行的状态。

 阻塞状态：进程由于等待资源或某个事件的发生而暂停执行的状态。 

1.2 进程状态的转换

![进程状态转换](https://img.tim-wcx.ltd/i/2022/06/08/62a007964aad7.png)

1.3 进程的组织

​	当系统中有很多进程时，可以用队列把进程控制块组织起来，形成进程队列。把具有相同状态的进程放在同一个队列中，具有不同状态的进程就可形成不同的进程队列。处于就绪状态的进程构成的进程队列称为就绪队列，处于阻塞状态的进程构成的进程队列称为阻塞队列。

1.4 链接方式

​    把具有相同状态的PCB用其中的链接字，链接成一个队列。就绪队列、执行队列和阻塞队列。

​	进程链表，循环队列

​	Pidhash表及链表 参考：[Linux内核探秘——进程（二）](https://zhuanlan.zhihu.com/p/361324735)

​	进程树

​	结构数组

2、进程的创建

2.1 引起创建进程的事件：① 用户登录 ② 作业调度③ 提供服务④ 应用请求     

2.2 进程创建 调用创建新进程的原语来创建进程，一般步骤为： ① 申请空白PCB② 为新进程分配资源③ 初始化进程控制块 ④ 将新进程插入就绪队列

3、进程阻塞

3.1 引起进程阻塞和唤醒的事件①请求系统服务，如：打印服务。②启动某种操作，如：启动I/O或启动打印机。③ 新数据尚未到达，如：一个计算进程，如果新的输入 数据还没有到达，则计算进程需要阻塞等待。

3.2 进程阻塞的简化过程①暂停进程的执行，将进程的状态改为阻塞态。②将进程插入相应的阻塞队列。③转进程调度程序，重新进行进程调度。

4、进程唤醒

4.1 进程唤醒过程 ①将进程从阻塞队列中移出 ②将进程状态由阻塞改为就绪 ③将进程插入就绪队列

5、进程的终止

5.1 引起进程终止的事件①正常结束②异常结束③外界干预

5.2 进程终止过程 ①从进程PCB中读进程状态②若进程正在执行则终止进程的执行③若进程有子孙进程则终止子孙进程*(不一定）④释放资源 ⑤将终止进程的PCB“移”出

> 注：系统引导过程：
>
> 执行BIOS程序将BOOT程序加载入内存
>
> 执行BOOT程序，从外存找到Loader程序，将其加载入内存，并执行该程序
>
> Loader程序将内核程序从外存加载入内存
>
> 内核开始执行
>

#### 5 操作系统内核

1、中断

中断是改变处理器执行指令顺序的一种事件。这样的事件与CPU芯片内外部 硬件电路产生的电信号相对应 。

计算机在执行程序的过程中，当出现中断时，计算机停止现行程序的运行，转向对这些中断事件的处理，处理结束后再返回到现行程序的间断处。

引入中断机制能有效提高CPU的利用率，改善系统性能。

为什么引入中断？引入中断机制后，CPU可以与其它设备并行工作，能有效提高CPU的利用率，改善系统性能，支持系统的异步性。

1.1 中断类型

内部中断和外部中断

1.2 中断响应

响应外部中断的条件:开中断

响应外部中断的时机:CPU每执行完一条指令

内部中断：随时可能产生

1.3 单重中断的执行

![单重中断的执行](https://img.tim-wcx.ltd/i/2022/06/08/62a0187fc55e7.png)

> 注：现在的计算机系统大多允许中断嵌套，在这样的系统中，保护完现场后就可以打开中断，允许响应新的中断。

1.4 如何找到中断服务程序？

不同中断源对应不同的中断向量

根据中断向量查找中断向量表

从中断向量表中读取中断服务程序的入口地址相关信息

中断服务程序的入口地址相关信息在内存中的地址=idtr中的地址+中断向量表表项的长度×中断向量的值，idtr中的地址即为中断向量表的起始地址。

1.5 关于中断OS要做的事情

初始化中断向量表

初始化中断向量表寄存器（idtr寄存器）

执行中断处理程序

1.6 需要了解的硬件：

不同中断源对应的中断向量值

可编程中断控制器接口（PIC 可编程中断控制器）

与中断相关的寄存器名称及其用途

2、时钟管理

2.1 时钟的重要性

定时测量 

编译程序

防止进程垄断CPU或其他资源(CPU时间片)

与时钟相关的软件需要时钟支持

2.2 计算机系统中的时钟

大部分PC机中有两个时钟源，分别叫做RTC和OS时钟。

RTC时钟也叫CMOS时钟，是一块时钟芯片，靠电池供电，为计算机提供计时标准，是最原始、最底层的数据。

OS时钟产生于PC主板上的定时/计数芯片，在开机时有效。

![时钟运作机制](https://img.tim-wcx.ltd/i/2022/06/08/62a01b1c9fa21.png)

2.3 操作系统的时钟机制

2.3.1 操作系统内核需要完成的定时测量功能：

1.保存当前的日期和时间；2.维持定时器。

2.3.2 如何实现？

1.操作系统依靠时钟硬件（可编程间隔定时器）2.时钟软件（时钟驱动程序）

2.3.3 OS时钟硬件（可编程间隔定时器PIT，Programmable Interval Timer)）

功能：按指定的时间间隔产生时钟中断，测量逝去的时间,并触发与时间有关的操作。

组成：OS时钟由三个元件组成：晶振、计数器、保持寄存器。

![PIT](https://img.tim-wcx.ltd/i/2022/06/08/62a01c41bf609.png)

![image-20220608114949661](https://img.tim-wcx.ltd/i/2022/06/08/62a01c5e0606f.png)

2.3.4 时钟软件（时钟驱动程序）

时钟驱动程序做的几件事：

①维护日期、时间   ②递减时间片并检查是否为零，防止进程运行超时 ③对 CPU的使用情况记帐 ④递减报警计数器

3、系统调用

系统调用是一群预先定义好的模块,它们提供一条管道让应用程序或一般用户能由此得到核心程序的服务。系统调用是核心程序与用户程序之间的接口，在类UNIX系统中，系统调用多使用C语言所提供的函数库接口。如：在程序中，使用C的函数printf(   )。

3.1 系统调用与一般函数的区别

系统调用实现例程运行在系统态（核心态）而一般函数运行在用户态。

系统调用与一般函数调用的执行过程是不同的。当系统调用执行时，当前进程被中断，由系统找相应的系统调实现例程，并在系统态下执行，执行结果返回进程。 

系统调用要进行“中断处理”比一般函数调用多了一些系统开销。

> 注：CPU内核态和用户态
>
> （1）内核态执行
>
> 内核空间是指含有一切系统核心代码的地址空间，当CPU执行系统核心代码时，称进程处于内核态执行，CPU状态为内核态。
>
> （2）用户态执行
>
> 用户空间是指用户进程所处的地址空间，当CPU执行用户空间的代码时，称该进程在用户态执行。CPU状态为用户态
>
> 0x 0000_0000 ~  0x BFFF_FFFF 用户空间 3GB
>
> 0x C000_0000 ~  0x FFFF_FFFF 内核空间 1GB

